# neoh Backend

Watch random videos with your friends!

-   [Local Development](#local-development)

# Local Development

## Running the stack with Docker and Docker-Compose

Start with Docker Compose:

```bash
docker-compose up -d
```

Now you can interact with it via these URLs:

Backend, API built with FastAPI: http://localhost/api

Autogenerated API Documentation with Swagger UI: http://localhost/docs

PGAdmin, Postgres Administration: http://localhost:5050

Flower, Celery monitoring dashboard: http://localhost:5555

Traefik UI, to see how routes are being handled by the proxy: http://localhost:8090

**Note:** The first time you startup, it may take a few minutes to build the docker images, but images will be re-used if they are already found in your system and up to date. The backend and celery worker images will also perform checks to ensure the database is running before starting up.

To check the logs of any individual container, you can run this command for the desired service:

```bash
docker-compose logs backend
```

## Project Setup

1. Create a venv:

    ```bash
    python -m venv .venv
    ```

2. Activate venv:

    ```bash
    source .venv/bin/activate
    ```

3. Install dependencies by running this command from the `backend/app` directory:

    ```bash
    python -m pip install -e ".[tests]"
    ```

Next you need to copy the contents of `env-example` to a new file named `.env`. The contents of the example file should work for running in local development.

## Editor Setup

Ensure your editor is using the venv you previously created, and that it is setup to run lfake8, mypy, black, and isort. For VSCode the following workspace settings should give you everything you need:

```json
{
    "python.linting.pylintEnabled": false,
    "python.linting.flake8Enabled": true,
    "python.linting.flake8Args": ["--config=backend/app/setup.cfg"],
    "python.pythonPath": "backend/app/.venv/bin/python",
    "python.linting.mypyArgs": ["--config-file=backend/app/setup.cfg"],
    "editor.formatOnSave": true,
    "python.formatting.provider": "black",
    "[python]": {
        "editor.codeActionsOnSave": {
            "source.organizeImports": true
        }
    },
    "python.linting.mypyEnabled": true
}
```

## Docker Compose Override

The file `docker-compose.override.yml` will be automatically used by the `docker-compose` command and will override settings found in the main `docker-compose.yml`. This is where settings for local development are stored. If settings needs changed that pertain only to local development they should be done here.

## Migrations

During local development, the app directory is mounted as a volume inside the contianer, so migrations can be generated from within the `backend` container. To generate new migrations after making changes to existing models or adding new ones follow these steps:

Note taht all models must be imported in the file `./backend/app/neoh_backend/db/base.py` in order to be seen by Alembic for generating migrations.

1. Start a bash session in the backend container:

    ```bash
    docker-compose exec backend bash
    ```

2. Run alembic revision with autogenerate flag and a message:

    ```bash
    alembic reivision --autogenerate -m "Add column last_name to User model"
    ```

3. Run alembic upgrade to make the changes in the database(this is what actually aplies the migration to the database):

    ```bash
    alembic upgrade head
    ```
